#!/bin/bash
TEX_=$1
basename=${TEX_%*.tex_}
QTEX=${basename}.qtex
echo "$TEX_ -> $QTEX"
answs=()
correct=()
while read -r flag val; do
    if [[ "$flag" == "#ANS" ]]; then
        case "$val" in
            "CM")
                qtype=multichoice
                ;;
            "A")
                qtype=matching
                ;;
        esac
    fi
    if [[ "$flag" == "#TAGS" ]]; then
        tags="$flag ${val//#/}"
    fi
    if [[ "$flag" =~ ^[A-D]\.  ]];then
        answ=$(echo "$val" | sed -E 's/[[:space:]]*(.*)[[:space:]]*\\newline.*$/\1/')
        answs+=("$answ")
        if [[ $val == *✓* ]]; then
            correct+=(1)
        else
            correct+=(0)
        fi
    fi
done < $TEX_ 

# Calcul du nombre de bonnes réponses
nb_correct=0
for c in "${correct[@]}"; do
    (( nb_correct += c ))
done
# Calcul du score par bonne réponse
if (( nb_correct > 0 )); then
    score=$(awk "BEGIN { printf \"%.1f\", 100/$nb_correct }")
else
    score="0.0"
fi

# WRITINF QTEX
echo "#TYPE $qtype" > $QTEX
echo "#NAME $basename" >> $QTEX
grep "#Q" $TEX_ >> $QTEX
cat <<EOF >> $QTEX
#GFBACK Merci d'avoir pris le temps de répondre à cette question.
#CFBACK Bravo! Votre réponse est correcte.
#PFBACK Votre réponse est partiellement correcte.
#IFBACK Votre réponse est incorrecte.
EOF
# Affichage des ANSW_GRAD
for c in "${correct[@]}"; do
    if (( c == 1 )); then
        echo "#ANSW_GRAD $score"
    else
        echo "#ANSW_GRAD 0.0"
    fi
done >> $QTEX
# Affichage des ANSW_TEXT
for ans in "${answs[@]}"; do
    echo "#ANSW_TEXT $ans"
done >> $QTEX
echo "#TAGS ${tags}" >> $QTEX
