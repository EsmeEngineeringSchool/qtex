#!/bin/bash
# proposition de modification chatgpt
#-e : stop au premier échec
#-u : variable non définie = erreur
#-o pipefail : échec dans un pipe détecté
set -euo pipefail
IFS=$'\n\t'
log() { (( VERBOSE )) && echo "[INFO] $*"; }
usage()
{
    echo "Usage: $(basename "$0") [options] TEX_"
    echo "Options:"
    echo "  -o DIR   dossier de sortie (défaut: .)"
    echo "  -l LANG  langue (fr|en)"
    echo "  -v       mode verbeux"
    echo "  -n       dry-run (pas d'écriture)"
    exit 1
}
VERBOSE=0
DRY_RUN=0
LANG=fr
OUTDIR=.
while getopts ":vl:o:n" opt; do
    case $opt in
        v) VERBOSE=1 ;;
        n) DRY_RUN=1 ;;
        l) LANG="$OPTARG" ;;
        o) 
            OUTDIR="$OPTARG" 
            mkdir -p "$OUTDIR"
            ;;
        *)
            usage
            ;;
    esac
done
shift $((OPTIND - 1))
TEX_=$1
[[ -z "$TEX_" ]] && usage
[[ -f "$TEX_" ]] || { echo "Fichier introuvable: $TEX_" >&2; exit 1; }

case "$LANG" in
    fr)
        GFBACK="Merci d'avoir pris le temps de répondre à cette question."
        CFBACK="Bravo ! Votre réponse est correcte."
        PFBACK="Votre réponse est partiellement correcte."
        IFBACK="Votre réponse est incorrecte."
        ;;
    en)
        GFBACK="Thank you for taking the time to answer this question."
        CFBACK="Well done! Your answer is correct."
        PFBACK="Your answer is partially correct."
        IFBACK="Your answer is incorrect."
        ;;
    *)
        echo "Langue non supportée : $LANG" >&2
        exit 1
        ;;
esac

bse=$(basename "$TEX_")
name=${bse%*.tex_}
QTEX=$OUTDIR/$name.qtex
OUT="$QTEX"
(( DRY_RUN )) && OUT=/dev/stdout
log "$TEX_ -> $QTEX"
answs=()
correct=()
while IFS= read -r line; do
    flag=${line%% *}
    val=${line#"$flag"}
    val=${val# }
    if [[ "$flag" == "#ANS" ]]; then
        case "$val" in
            "CM") qtype=multichoice;;
            "A")  qtype=matching;;
            *)
                echo "Type de question inconnu: $val" >&2
                exit 1
                ;;
        esac
    fi
    if [[ "$flag" == "#TAGS" ]]; then
        tags="$flag ${val//#/}"
    fi
    if [[ "$line" =~ ^[A-D]\.\  ]];then
        answ=$(sed -E 's/[[:space:]]*(.*)[[:space:]]*\\newline.*$/\1/' <<< "$val")
        answs+=("$answ")
        if [[ $val == *✓* ]]; then
            correct+=(1)
        else
            correct+=(0)
        fi
    fi
done < $TEX_ 

# Calcul du nombre de bonnes réponses
nb_correct=0
for c in "${correct[@]}"; do
    (( nb_correct += c ))
done
# Calcul du score par bonne réponse
if (( nb_correct > 0 )); then
    score=$(printf "%.1f" "$(bc -l <<< "100/$nb_correct")")
else
    score="0.0"
fi

# WRITING QTEX
echo "#TYPE $qtype" > $OUT
echo "#NAME $name" >> $OUT
#grep "#Q" $TEX_ | tex2html >> $QTEX
tex2html < <(grep "#Q" "$TEX_") >> "$OUT"
cat <<EOF >> $OUT
#GFBACK $GFBACK
#CFBACK $CFBACK
#PFBACK $PFBACK
#IFBACK $IFBACK
EOF
# Affichage des ANSW_GRAD
for c in "${correct[@]}"; do
    if (( c == 1 )); then
        echo "#ANSW_GRAD $score"
    else
        echo "#ANSW_GRAD 0.0"
    fi
done >> $OUT
# Affichage des ANSW_TEXT
for ans in "${answs[@]}"; do
    printf '#ANSW_TEXT %s\n' "$(tex2html <<< "$ans")"
done >> $OUT
echo "${tags}" >> $OUT
