#!/bin/bash
usage()
{
    echo "Usage: $(basename $0) TEX_ [OUTDIR]"
    echo "TEX_ : fichier tex_ à transformer au format qtex"
    echo "OUTDIR : dossier de sortie"
    exit 1
}
TEX_=$1
[ $# -gt 2 ] || [ $# -eq 0 ] && usage
OUTDIR=.
if [ $# -eq 2 ]
then
    OUTDIR=$2
fi
[ ! -d $OUTDIR ] && mkdir $OUTDIR
bse=$(basename $TEX_)
name=${bse%*.tex_}
QTEX=$OUTDIR/$name.qtex
echo "$TEX_ -> $QTEX"
answs=()
correct=()
while read -r flag val; do
    if [[ "$flag" == "#ANS" ]]; then
        case "$val" in
            "CM")
                qtype=multichoice
                ;;
            "A")
                qtype=matching
                ;;
        esac
    fi
    if [[ "$flag" == "#TAGS" ]]; then
        tags="$flag ${val//#/}"
    fi
    if [[ "$flag" =~ ^[A-D]\.  ]];then
        answ=$(echo "$val" | sed -E 's/[[:space:]]*(.*)[[:space:]]*\\newline.*$/\1/')
        answs+=("$answ")
        if [[ $val == *✓* ]]; then
            correct+=(1)
        else
            correct+=(0)
        fi
    fi
done < $TEX_ 

# Calcul du nombre de bonnes réponses
nb_correct=0
for c in "${correct[@]}"; do
    (( nb_correct += c ))
done
# Calcul du score par bonne réponse
if (( nb_correct > 0 )); then
    score=$(awk "BEGIN { printf \"%.1f\", 100/$nb_correct }")
else
    score="0.0"
fi

# WRITING QTEX
echo "#TYPE $qtype" > $QTEX
echo "#NAME $name" >> $QTEX
grep "#Q" $TEX_ >> $QTEX
cat <<EOF >> $QTEX
#GFBACK Merci d'avoir pris le temps de répondre à cette question.
#CFBACK Bravo! Votre réponse est correcte.
#PFBACK Votre réponse est partiellement correcte.
#IFBACK Votre réponse est incorrecte.
EOF
# Affichage des ANSW_GRAD
for c in "${correct[@]}"; do
    if (( c == 1 )); then
        echo "#ANSW_GRAD $score"
    else
        echo "#ANSW_GRAD 0.0"
    fi
done >> $QTEX
# Affichage des ANSW_TEXT
for ans in "${answs[@]}"; do
    echo "#ANSW_TEXT $ans"
done >> $QTEX
echo "${tags}" >> $QTEX
