#!/bin/bash
set -euo pipefail
usage()
{
    echo "Usage: $0 [-c] -i <input_qtex_file>" 
    exit 1
}
#Quelques variables de chemin
QTEX_ROOT="/home/filipe/dev/qtex/"
QTEX_SRC="$QTEX_ROOT/src"
QTEX_TESTS="$QTEX_ROOT/tests"
TEMPLATE="$QTEX_SRC/qtex/qtex2latex/templates/template_beamer_simple.tex"
BUILD="$QTEX_TESTS/build"
TEX_OUTPUT=${BUILD}/tmp_simple.tex
PDF_OUTPUT=${BUILD}/tmp_simple.pdf
LOG_OUTPUT=${BUILD}/pdflatex.log
# Options
CORRIGE=false
QTEX=""
VIEW=true
while getopts ":ci:" opt; do
    case "$opt" in
        c)  CORRIGE=true ;;
        i)  QTEX="$OPTARG" ;;
        n)  VIEW=false ;;
        *)  usage ;;
    esac
done
# VÃ©rifications
[ -z "$QTEX" ] && usage
[ ! -f "$QTEX" ] && { echo "Erreur : fichier '$QTEX' introuvable"; exit 1; }

mkdir -p "$BUILD"
[ ! -f "$TEMPLATE" ] && { echo "Template LaTeX introuvable"; exit 1; }
cp "$TEMPLATE" "$TEX_OUTPUT"
SHUFFLE=$(shuf -i 0-3 | paste -sd' ')
qtex2frame -i ${QTEX} -s ${SHUFFLE} >> $TEX_OUTPUT
if $CORRIGE; then 
    qtex2frame --corrige -i ${QTEX} -s ${SHUFFLE} >> $TEX_OUTPUT
fi
echo "\end{document}" >> $TEX_OUTPUT 
pdflatex -output-directory $BUILD $TEX_OUTPUT > $LOG_OUTPUT 2>&1 
if $VIEW; then
    mupdf -r 216 $PDF_OUTPUT 2> /dev/null & 
fi
